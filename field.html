<!DOCTYPE html>
<html lang="en">
<head>
    <title>Your Crop!</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="main.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>       
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="config.js"></script>

    <!-- navbar -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <ul class="navbar-nav">
            <a class="navbar-brand" href="#">Farm2Fresh</a>            
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="addField">Add a Field</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="#" id="curr-field"></a>
            </li>            
        </ul> 
    </nav>
</head>

<body>
    <br>
    <br>
    <p>These are the results of your area's Rainfall/Land last week, calculated by PPET. A rise in PPET indicates increase in water for your area. If near the threshold, then irrigation may not be necessary for that week.</p>
    <div class="row">
        <!--<div class="col-sm-4">
            <a id="add-crop-btn"><button type="button" class="btn btn-outline-secondary">Add a crop to this field</button></a>
            <div id="get-agronomic"></div>
        </div>-->
        <div class="col-sm-4">
            <div class="chart-container" style="position: relative; height:740px; width:780px">
                <canvas id="generateChart"></canvas>
            </div>
        </div>
    </div>
    <p>This is your future rain forecast, calculated by your farm's location. If the chance of rain is greater than 50%, consider not irrigating your crop if PPET is also increasing.</p>
    <div class="row">
        <div class="col-sm-4">
            <div class="chart-container" style="position: relative; height:740px; width:780px">
                <canvas id="myChart"></canvas>            
            </div>
        </div>
    </div>
</body>

<script>

    const urlv2 = new URL(window.location)
    const paramsv2 = new URLSearchParams(urlv2.search)
    const uri = '/v2/weather/fields/' + paramsv2.get("fieldId") + '/forecasts?units=usa&properties=temperature,precipitation&limit=7'

    const uri2 = '/v2/agronomics/fields/' + paramsv2.get("fieldId") + '/agronomicnorms' 
    
    /*var agro = document.createElement('a')
    agro.href = '/agronomic?fieldId=' + paramsv2.get("fieldId")
    agro.innerHTML = '<button>Check out historical agronomic data</button>'

    document.getElementById('get-agronomic').appendChild(agro)*/
    document.getElementById('curr-field').innerHTML = paramsv2.get("fieldId")
    //document.getElementById('add-crop-btn').setAttribute("href", "addCrop?fieldId=" + paramsv2.get("fieldId"))

    $.ajax({
        url: host + uri,
        type: "GET",
        beforeSend: (xhr) => {xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN)},
        success: (response) => {            
            var chance = new Array(0,0,0,0,0,0,0); // chance of precipitation
            var days = [];

            for(i = 0; i < 7; i++){ // 7 days a week
                const day = response.forecasts[i].date
                console.log('date = ' + day);
                console.log("made it");
                days.push(day)
                for(var j = 0; j < 24; j++){ // 24 hours a day
                    const pptchance = response.forecasts[i].forecast[j].precipitation.chance;                             
                    // console.log(response.forecasts[i].forecast[j].precipitation)
                    // console.log("chance=" + chance + " chance[" + i + "]=" + chance[i]);
                    if( pptchance > chance[i]){                                        
                        chance[i] = pptchance; // if pptchance > 0 find max pptchance of day
                    } 
                }
                
            }
                
            generateChart(chance, days);
        }//end of success ajax1
    })//end of ajax1

    //ajax2 for PPET
   $.ajax({
        url: host + uri2,
        type: "GET",
        beforeSend: (xhr) => {xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN)},
        success: (response) => {    

            var days = [];
            var ppet = [];
            var threshold = [];

            for(var day of response["dailyNorms"]){
                console.log(day); 
                days.push(day.day);
                ppet.push(day.ppet.average);
                threshold.push(1);
            }
            //console.log("going out");
            var dataset = new Array(ppet, threshold);
            //console.log(dataset);
            generateGraph(days, dataset);
        }//end of success ajax2
    })//end of ajax2
    

    /*
    function parseWeather(response) {    
        var chance = new Array(0,0,0,0,0,0,0); // chance of precipitation
        var days = [];
        
        for(i = 0; i < 7; i++){ // 7 days a week
            const day = response.forecasts[i].date
            console.log('date = ' + day);
            days.push(day)
            for(var j = 0; j < 24; j++){ // 24 hours a day
                const pptchance = response.forecasts[i].forecast[j].precipitation.chance;                             
                // console.log(response.forecasts[i].forecast[j].precipitation)
                // console.log("chance=" + chance + " chance[" + i + "]=" + chance[i]);
                if( pptchance > chance[i]){                                        
                    chance[i] = pptchance; // if pptchance > 0 find max pptchance of day
                } 
            }
            
        }
            
        generateChart(chance, days);
        
    }

    $(function() { 
        parseWeather(weatherResp);        
    })    
    */
   
    // chart.js
    function generateChart(data, labels) {        
        var ctx = document.getElementById("myChart").getContext("2d");
        var chartType = {        
            type: 'line',            
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    label: "Chance of Rain",
                    fill: false,
                    borderColor: "#8e5ea2"
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Chance of Rain Next Week"
                }
            }                
        };

        var myChart = new Chart(ctx, chartType);
    }

    function generateGraph(days, data){
        var ctx2 = document.getElementById("generateChart").getContext("2d");
        var chartType = {        
            type: 'line',            
            data: {
                labels: days,
                datasets: [{
                        data: data[0],
                        label: "PPET",
                        fill: false,
                        borderColor: "#8e5ea2"      
                    } ,{
                        data: data[1],
                        label: "Irrigation Threshold",
                        fill: false,
                        borderColor: "#FF0000"      
                    } 
                ]
            },
            options: {
                title: {
                    display: true,
                    text: "Your Area's Rainfall/Land Last Week"
                }
            }                
        };

        var myChart2 = new Chart(ctx2, chartType);   
    }
</script>
</html