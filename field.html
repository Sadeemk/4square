<!DOCTYPE html>
<html lang="en">
<head>
    <title>Your Crop!</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="main.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>   
    <script src="config.js"></script>
    <link rel="stylesheet" type="text/css" href="graph.css">
</head>


<body>
    <p>Hello</p>
    <div class="chart-container" style="position: relative; height:740px; width:780px">
        <canvas id="myChart"></canvas>
    </div>

    <div id="add-crop"></div>
    <div id="get-agronomic"></div>
    <h1  id="crop-name"></h1> 
    <div id="crop-img"></div>
    <div id="crop-facts"></div>
    <div id="weather"></div>   
</body>

<!-- weather API -->

<script>
    const urlv2 = new URL(window.location)
    const paramsv2 = new URLSearchParams(urlv2.search)
    const uri = '/v2/weather/fields/' + paramsv2.get("fieldId") + '/forecasts?units=usa&limit=3&offset=3'
    var elem = document.createElement('a')
    elem.href = 'addCrop?fieldId=' + paramsv2.get("fieldId")
    elem.innerHTML = '<button>Add a crop to this field</button>'
    var agro = document.createElement('a')
    agro.href = '/agronomic?' + paramsv2.get("fieldId")
    agro.innerHTML = '<button>Check out historical agronomic data</button>'
    document.getElementById('add-crop').appendChild(elem)
    document.getElementById('get-agronomic').appendChild(agro)

    /*
    $.ajax({
        url: host + uri,
        type: "GET",
        beforeSend: (xhr) => {xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN)},
        success: (response) => {
            console.log(response.forecasts[0])  
            for(var i = 0; i < 3;i++){
                console.log('date = ' + response.forecasts[i].date);
                $('#weather').append(
                    '<li>'+ 'date = ' + response.forecasts[i].date
                )
                for(var j = 0; j < 24; j++){
                    console.log(response.forecasts[i].forecast[j].conditionsText);
                    const v = j+1
                    $('#weather').append(
                        '<li>Hour:' + j + '-' + v + ' ' + response.forecasts[i].forecast[j].conditionsText 
                    )
                }
            }
        }
    })
    */

    function parseWeather(response) {    
        var chance = [];
        var days = [];
        for(i = 0; i < 7; i++){ // 7 days a week
            const day = response.forecasts[i].date
            console.log('date = ' + day);
            days.push(day)
            for(var j = 0; j < 1; j++){ // 24 hours a day
                const forecast = response.forecasts[i].forecast[j];
                // console.log(forecast.precipitation)
                chance.push(forecast.precipitation.chance)
            }
        }
        console.log(chance);        
        generateChart(chance, days);
        
    }

    $(function() { 
        parseWeather(weatherResp);
        
    })

    // chart.js
    function generateChart(data, labels) {        
        var ctx = document.getElementById("myChart").getContext("2d");
        var chartType = {        
            type: 'line',            
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    label: "Chance of Rain",
                    fill: false,
                    borderColor: "#8e5ea2"
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Chance of rain for the next week"
                }
            }                
        };

        var myChart = new Chart(ctx, chartType);   
    }
</script>
</html